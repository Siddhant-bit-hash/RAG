<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with PDF - Gemini Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .prose {
            max-width: 100%;
        }
        .user-message {
            background-color: #dbeafe;
            align-self: flex-end;
        }
        .bot-message {
            background-color: #ffffff;
            align-self: flex-start;
        }
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased text-gray-800">

    <div class="flex-shrink-0 bg-white p-4 shadow-md z-10">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-2xl font-bold text-center text-gray-700">Chat with PDF (Gemini Edition)</h1>
            <p class="text-center text-sm text-gray-500 mt-1">Upload a PDF and ask questions about its content.</p>
        </div>
    </div>

    <div class="flex-grow flex flex-col md:flex-row max-w-7xl mx-auto w-full p-4 gap-4 overflow-hidden">
        
        <!-- Left Panel: Controls -->
        <div class="w-full md:w-1/3 flex flex-col gap-4">
            <div class="bg-white p-5 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">1. Set API Key</h2>
                <input type="password" id="apiKey" placeholder="Enter your Google AI API Key" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-2">Your key is used only for API calls and is not stored.</p>
            </div>

            <div class="bg-white p-5 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">2. Upload PDF</h2>
                <div class="flex items-center justify-center w-full">
                    <label for="pdfUpload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-2 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                            </svg>
                            <p class="mb-1 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        </div>
                        <input id="pdfUpload" type="file" class="hidden" accept=".pdf" />
                    </label>
                </div> 
                <p id="pdfStatus" class="text-sm text-center text-gray-600 mt-3">No file selected.</p>
            </div>
             <div id="processing-indicator" class="hidden items-center justify-center text-gray-600">
                <div class="loader"></div>
                <span>Processing PDF...</span>
            </div>
        </div>

        <!-- Right Panel: Chat Interface -->
        <div class="w-full md:w-2/3 flex flex-col bg-white rounded-lg shadow">
            <div id="chat-container" class="flex-grow p-6 overflow-y-auto">
                <div class="flex flex-col gap-4">
                    <!-- Chat messages will be appended here -->
                     <div class="bot-message message-bubble">
                        <div class="prose">Hello! Please provide your API key and upload a PDF to get started.</div>
                    </div>
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
                <div class="relative flex">
                    <input type="text" id="userInput" placeholder="Ask a question about the PDF..." class="w-full p-3 pr-12 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                    <button id="sendButton" class="absolute right-1 top-1/2 -translate-y-1/2 p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-300" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        const apiKeyInput = document.getElementById('apiKey');
        const pdfUploadInput = document.getElementById('pdfUpload');
        const pdfStatus = document.getElementById('pdfStatus');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const chatContainer = document.getElementById('chat-container').firstElementChild;
        const processingIndicator = document.getElementById('processing-indicator');

        let pdfText = '';
        let textChunks = [];
        let chatHistory = [];

        // --- Event Listeners ---

        pdfUploadInput.addEventListener('change', handlePdfUpload);
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // --- Core Functions ---

        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                pdfStatus.textContent = 'Please select a valid PDF file.';
                return;
            }

            pdfStatus.textContent = `Loading "${file.name}"...`;
            processingIndicator.classList.remove('hidden');
            processingIndicator.classList.add('flex');

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    pdfText = fullText;
                    textChunks = splitTextIntoChunks(pdfText, 2000); // Split into chunks of 2000 chars
                    
                    pdfStatus.textContent = `âœ… Ready: "${file.name}"`;
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    addMessageToChat('bot', 'PDF processed successfully! You can now ask questions.');
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error processing PDF:', error);
                pdfStatus.textContent = 'Error processing PDF.';
                addMessageToChat('bot', 'Sorry, there was an error processing the PDF. Please try another file.');
            } finally {
                processingIndicator.classList.add('hidden');
                processingIndicator.classList.remove('flex');
            }
        }
        
        async function handleSendMessage() {
            const userQuery = userInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            if (!userQuery) return;
            if (!apiKey) {
                addMessageToChat('bot', 'Please enter your API key before sending a message.');
                return;
            }
            if (!pdfText) {
                addMessageToChat('bot', 'Please upload a PDF file first.');
                return;
            }

            addMessageToChat('user', userQuery);
            userInput.value = '';
            showLoadingIndicator();

            try {
                // 1. Find relevant context from the PDF
                const context = findRelevantContext(userQuery, textChunks);

                // 2. Construct the prompt
                const prompt = `
                    Based on the following context from a PDF document and our chat history, please provide a helpful and concise answer to the user's question.
                    
                    ---
                    CONTEXT FROM PDF:
                    ${context}
                    ---
                    CHAT HISTORY:
                    ${formatChatHistory(chatHistory)}
                    ---
                    USER'S QUESTION:
                    "${userQuery}"
                    ---

                    ANSWER:
                `;

                // 3. Call Gemini API
                const model = 'gemini-2.5-flash-preview-09-2025'; // Using the specified model
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const botResponse = result.candidates[0].content.parts[0].text;
                
                hideLoadingIndicator();
                addMessageToChat('bot', botResponse);
                
                // Update chat history
                chatHistory.push({ role: 'user', text: userQuery });
                chatHistory.push({ role: 'bot', text: botResponse });


            } catch (error) {
                console.error('Error calling Gemini API:', error);
                hideLoadingIndicator();
                addMessageToChat('bot', `Sorry, an error occurred: ${error.message}`);
            }
        }
        
        // --- Helper Functions ---

        function addMessageToChat(sender, message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-bubble ${sender === 'user' ? 'user-message' : 'bot-message'}`;
            
            const proseDiv = document.createElement('div');
            proseDiv.className = 'prose';
            
            // A simple way to format basic markdown like **bold** and *italic*
            let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedMessage = formattedMessage.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formattedMessage = formattedMessage.replace(/\n/g, '<br>');

            proseDiv.innerHTML = formattedMessage;
            messageWrapper.appendChild(proseDiv);
            chatContainer.appendChild(messageWrapper);
            chatContainer.parentElement.scrollTop = chatContainer.parentElement.scrollHeight;
        }

        function showLoadingIndicator() {
            const loadingBubble = document.createElement('div');
            loadingBubble.id = 'loading-indicator';
            loadingBubble.className = 'bot-message message-bubble flex items-center';
            loadingBubble.innerHTML = `<div class="loader"></div><span>Thinking...</span>`;
            chatContainer.appendChild(loadingBubble);
            chatContainer.parentElement.scrollTop = chatContainer.parentElement.scrollHeight;
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function splitTextIntoChunks(text, chunkSize) {
            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.substring(i, i + chunkSize));
            }
            return chunks;
        }

        function findRelevantContext(query, chunks) {
            // This is a simple keyword-based retrieval. 
            // A more advanced implementation would use embeddings and vector similarity.
            const queryWords = new Set(query.toLowerCase().split(/\s+/));
            const scoredChunks = chunks.map(chunk => {
                const chunkWords = new Set(chunk.toLowerCase().split(/\s+/));
                let score = 0;
                for (const word of queryWords) {
                    if (chunkWords.has(word)) {
                        score++;
                    }
                }
                return { chunk, score };
            });

            scoredChunks.sort((a, b) => b.score - a.score);
            
            // Return the top 2 most relevant chunks
            return scoredChunks.slice(0, 2).map(item => item.chunk).join('\n\n---\n\n');
        }

        function formatChatHistory(history) {
            if (history.length === 0) return "No previous conversation.";
            // Get the last 4 messages (2 turns)
            return history.slice(-4).map(msg => `${msg.role === 'user' ? 'User' : 'Bot'}: ${msg.text}`).join('\n');
        }

    </script>
</body>
</html>
