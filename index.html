<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with PDF - Gemini Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fa;
        }
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 3px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .prose {
            max-width: 100%;
        }
        .prose strong { color: inherit; }
        .prose em { color: inherit; }

        .user-message {
            background-color: #2563eb;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .bot-message {
            background-color: #ffffff;
            color: #374151;
            align-self: flex-start;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
        }
        .message-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            transition: transform 0.2s ease-in-out;
        }
        .message-bubble:hover {
            transform: translateY(-2px);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #pdfUploadLabel.dragging {
            background-color: #e0f2fe;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased text-gray-800">

    <header class="flex-shrink-0 bg-white p-4 border-b border-gray-200 z-10">
        <div class="max-w-6xl mx-auto flex items-center justify-center">
            <svg class="w-8 h-8 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" />
            </svg>
            <h1 class="text-2xl font-bold text-center text-gray-800">Chat with PDF</h1>
        </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row max-w-6xl mx-auto w-full p-4 gap-6 overflow-y-auto">
        
        <!-- Left Panel: Controls -->
        <div class="w-full md:w-1/3 lg:w-1/4 flex flex-col gap-4">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex flex-col h-full">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">Upload Document</h2>
                <div class="flex items-center justify-center w-full flex-grow">
                    <label id="pdfUploadLabel" for="pdfUpload" class="flex flex-col items-center justify-center w-full h-full border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center px-4">
                            <svg class="w-10 h-10 mb-3 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                            </svg>
                            <p class="mb-1 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag & drop</p>
                        </div>
                        <input id="pdfUpload" type="file" class="hidden" accept=".pdf" />
                    </label>
                </div> 
                <p id="pdfStatus" class="text-sm text-center text-gray-600 mt-4 truncate">No file selected.</p>
                <div id="processing-indicator" class="hidden items-center justify-center text-gray-600 mt-2">
                    <div class="loader !w-4 !h-4 !mr-2"></div>
                    <span class="text-sm">Processing PDF...</span>
                </div>
            </div>
        </div>

        <!-- Right Panel: Chat Interface -->
        <div class="w-full md:w-2/3 lg:w-3/4 flex flex-col bg-white rounded-xl shadow-sm border border-gray-200">
            <div id="chat-container" class="flex-grow p-6 overflow-y-auto bg-gray-50 rounded-t-xl">
                <div class="flex flex-col gap-4">
                    <!-- Chat messages will be appended here -->
                     <div class="bot-message message-bubble">
                        <div class="prose">Hello! Please upload a PDF document to get started.</div>
                    </div>
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="p-4 bg-white border-t border-gray-200 rounded-b-xl">
                <div class="relative flex">
                    <input type="text" id="userInput" placeholder="Ask a question about the PDF..." class="w-full p-3 pl-5 pr-14 text-sm border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" disabled>
                    <button id="sendButton" class="absolute right-1.5 top-1/2 -translate-y-1/2 p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-300 disabled:cursor-not-allowed transition-transform active:scale-95" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                          <path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.826L11.25 9.25v1.5l-7.5 1.548a.75.75 0 00-.95.826l1.414 4.949a.75.75 0 00.95.826L16.25 12l-13.145-9.711z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Setup ---
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        const GEMINI_API_KEY = "AIzaSyDgGofjdWHlMCuU_06tC-VOOP0Am5nDmEY";

        // --- DOM Elements ---
        const pdfUploadInput = document.getElementById('pdfUpload');
        const pdfUploadLabel = document.getElementById('pdfUploadLabel');
        const pdfStatus = document.getElementById('pdfStatus');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const chatContainer = document.getElementById('chat-container').firstElementChild;
        const processingIndicator = document.getElementById('processing-indicator');

        // --- State ---
        let pdfText = '';
        let textChunks = [];
        let chatHistory = [];

        // --- Event Listeners ---
        pdfUploadInput.addEventListener('change', handlePdfUpload);
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        // Drag and Drop functionality for PDF upload
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            pdfUploadLabel.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            pdfUploadLabel.addEventListener(eventName, () => pdfUploadLabel.classList.add('dragging'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            pdfUploadLabel.addEventListener(eventName, () => pdfUploadLabel.classList.remove('dragging'), false);
        });
        pdfUploadLabel.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                pdfUploadInput.files = files;
                handlePdfUpload({ target: pdfUploadInput });
            }
        }


        // --- Core Functions ---
        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                pdfStatus.textContent = 'Please select a valid PDF file.';
                pdfStatus.classList.add('text-red-500');
                return;
            }

            pdfStatus.textContent = `Loading "${file.name}"...`;
            pdfStatus.classList.remove('text-red-500');
            processingIndicator.classList.remove('hidden');
            processingIndicator.classList.add('flex');
            chatHistory = []; // Reset chat history on new upload

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    pdfText = fullText;
                    textChunks = splitTextIntoChunks(pdfText, 2000);
                    
                    pdfStatus.textContent = `âœ… Ready: "${file.name}"`;
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    chatContainer.innerHTML = ''; // Clear chat
                    addMessageToChat('bot', `PDF processed successfully! Feel free to ask any questions about "${file.name}".`);
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error processing PDF:', error);
                pdfStatus.textContent = 'Error processing PDF.';
                pdfStatus.classList.add('text-red-500');
                addMessageToChat('bot', 'Sorry, there was an error processing the PDF. Please try another file.');
            } finally {
                processingIndicator.classList.add('hidden');
                processingIndicator.classList.remove('flex');
            }
        }
        
        async function handleSendMessage() {
            const userQuery = userInput.value.trim();

            if (!userQuery) return;
            if (!pdfText) {
                addMessageToChat('bot', 'Please upload a PDF file first.');
                return;
            }

            addMessageToChat('user', userQuery);
            userInput.value = '';
            showLoadingIndicator();

            try {
                const context = findRelevantContext(userQuery, textChunks);
                const prompt = `Based on the following context from a PDF document and our chat history, please provide a helpful and concise answer to the user's question. If the context doesn't contain the answer, say that you couldn't find the information in the document.
                    
                    --- CONTEXT FROM PDF ---
                    ${context}
                    --- CHAT HISTORY ---
                    ${formatChatHistory(chatHistory)}
                    --- USER'S QUESTION ---
                    "${userQuery}"
                    --- ANSWER ---`;

                const model = 'gemini-2.5-flash-preview-09-2025';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
                const botResponse = result.candidates[0].content.parts[0].text;
                
                hideLoadingIndicator();
                addMessageToChat('bot', botResponse);
                
                chatHistory.push({ role: 'user', text: userQuery });
                chatHistory.push({ role: 'bot', text: botResponse });

            } catch (error) {
                console.error('Error calling Gemini API:', error);
                hideLoadingIndicator();
                addMessageToChat('bot', `Sorry, an error occurred: ${error.message}. Please check your API key and network connection.`);
            }
        }
        
        // --- Helper Functions ---
        function addMessageToChat(sender, message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-bubble ${sender === 'user' ? 'user-message' : 'bot-message'}`;
            
            const proseDiv = document.createElement('div');
            proseDiv.className = 'prose';
            
            let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedMessage = formattedMessage.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formattedMessage = formattedMessage.replace(/\n/g, '<br>');

            proseDiv.innerHTML = formattedMessage;
            messageWrapper.appendChild(proseDiv);
            chatContainer.appendChild(messageWrapper);
            chatContainer.parentElement.scrollTop = chatContainer.parentElement.scrollHeight;
        }

        function showLoadingIndicator() {
            const loadingBubble = document.createElement('div');
            loadingBubble.id = 'loading-indicator';
            loadingBubble.className = 'bot-message message-bubble flex items-center';
            loadingBubble.innerHTML = `<div class="loader"></div><span>Thinking...</span>`;
            chatContainer.appendChild(loadingBubble);
            chatContainer.parentElement.scrollTop = chatContainer.parentElement.scrollHeight;
        }

        function hideLoadingIndicator() {
            document.getElementById('loading-indicator')?.remove();
        }

        function splitTextIntoChunks(text, chunkSize) {
            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.substring(i, i + chunkSize));
            }
            return chunks;
        }

        function findRelevantContext(query, chunks) {
            const queryWords = new Set(query.toLowerCase().split(/\s+/).filter(w => w.length > 2));
            const scoredChunks = chunks.map(chunk => {
                const chunkWords = new Set(chunk.toLowerCase().split(/\s+/));
                let score = 0;
                for (const word of queryWords) {
                    if (chunkWords.has(word)) score++;
                }
                return { chunk, score };
            });

            scoredChunks.sort((a, b) => b.score - a.score);
            return scoredChunks.slice(0, 2).map(item => item.chunk).join('\n\n---\n\n');
        }

        function formatChatHistory(history) {
            if (history.length === 0) return "No previous conversation.";
            return history.slice(-4).map(msg => `${msg.role === 'user' ? 'User' : 'Bot'}: ${msg.text}`).join('\n');
        }
    </script>
</body>
</html>


